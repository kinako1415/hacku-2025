# MediaPipe統合・角度計算アルゴリズム

## MediaPipe Hands統合

### 初期化パターン
```typescript
const initializeMediaPipe = async (): Promise<Hands> => {
  const hands = new Hands({
    locateFile: (file) => 
      `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`,
  });
  
  hands.setOptions({
    maxNumHands: 1,                    // 1つの手のみ検出
    modelComplexity: 1,                // モデル複雑度
    minDetectionConfidence: 0.5,       // 検出信頼度閾値
    minTrackingConfidence: 0.5,        // 追跡信頼度閾値
  });
  
  return hands;
};
```

### ランドマーク定義
- **21点の手ランドマーク**: MediaPipe仕様準拠
- **3D座標**: x, y, z (正規化座標)
- **信頼度**: confidence値でデータ品質評価

## 角度計算アルゴリズム

### 3点ベクトル角度計算
```typescript
const calculateAngle = (p1: Point, p2: Point, p3: Point): number => {
  // ベクトル作成
  const vec1 = { x: p1.x - p2.x, y: p1.y - p2.y };
  const vec2 = { x: p3.x - p2.x, y: p3.y - p2.y };
  
  // 内積計算
  const dot = vec1.x * vec2.x + vec1.y * vec2.y;
  
  // ベクトルの大きさ
  const mag1 = Math.sqrt(vec1.x ** 2 + vec1.y ** 2);
  const mag2 = Math.sqrt(vec2.x ** 2 + vec2.y ** 2);
  
  // 角度計算（ラジアンから度へ変換）
  return Math.acos(dot / (mag1 * mag2)) * (180 / Math.PI);
};
```

### 手首角度測定
- **掌屈/背屈**: 手首-中指基部-中指先端の角度
- **尺屈/橈屈**: 手首-示指基部-小指基部の角度
- **基準値との比較**: 正常可動域との差分計算

### 母指角度測定
- **屈曲/伸展**: 母指基部-関節-先端の角度
- **内転/外転**: 母指と示指間の角度
- **対立運動**: 母指先端と他指先端間の距離

## データ検証・フィルタリング

### 信頼度チェック
- **最小信頼度**: 0.7以上のランドマークのみ使用
- **連続性チェック**: 前フレームとの差分が閾値以内
- **外れ値除去**: 統計的外れ値の検出・除去

### ノイズ除去
- **移動平均フィルタ**: 3フレーム平均でスムージング
- **カルマンフィルタ**: 予測モデルを用いたノイズ除去
- **メディアンフィルタ**: 瞬間的なスパイクノイズ除去

## 精度向上技術

### キャリブレーション
- **個人差補正**: ユーザー固有の手のサイズ・形状考慮
- **カメラ位置補正**: 撮影角度・距離の標準化
- **光環境補正**: 照明条件による影響軽減

### 多フレーム統合
- **連続測定**: 複数フレームの結果を統合
- **信頼度重み付け**: 高信頼度フレームを重視
- **時系列解析**: 動作パターンの一貫性チェック

## エラーハンドリング

### 検出失敗対応
- **再試行機構**: 検出失敗時の自動再試行
- **代替測定法**: 部分的なランドマークでの推定
- **ユーザーガイダンス**: 適切な手の位置・角度の指示

### データ品質管理
- **品質スコア**: 測定データの信頼性評価
- **警告システム**: 低品質データの警告表示
- **データ保存判定**: 一定品質以上のデータのみ保存