# どうやって測っているの? - わかりやすい解説

## シンプルな答え

**カメラで手を映すと、AIが手の形を21個の点として認識します。**
**その点と点の間の角度を、数学の計算で求めています。**

---

## 3ステップで理解する仕組み

### ステップ1: AIが手を「点」として見る

```
カメラ映像
    ↓
MediaPipe AI
    ↓
21個の3D座標点
```

MediaPipeというAIが、あなたの手を以下のように認識します:

```
        指先●
         ｜
        関節●
         ｜
   ●----●----●----●  ← 指の付け根(MCP)
         ｜
       手首●
```

各点は3つの数字で表されます:
- **X**: 左右の位置 (0.0 ~ 1.0)
- **Y**: 上下の位置 (0.0 ~ 1.0)
- **Z**: 奥行き (カメラから遠いほど大きい)

例: 手首 = `{x: 0.5, y: 0.6, z: 0.1}`

---

### ステップ2: 点と点を結んで「矢印(ベクトル)」を作る

```
点A (手首)
  ↓
  矢印
  ↓
点B (指の付け根)
```

この矢印の向きと長さが「ベクトル」です。

**計算方法:**
```
矢印 = 点B - 点A
     = (B.x - A.x, B.y - A.y, B.z - A.z)
```

**具体例:**
```
手首         = (0.5, 0.6, 0.1)
人差し指付け根 = (0.6, 0.4, 0.15)

矢印 = (0.6-0.5, 0.4-0.6, 0.15-0.1)
     = (0.1, -0.2, 0.05)
```

---

### ステップ3: 2つの矢印から「角度」を計算

```
      矢印2
       ↗
      ╱
     ╱ 角度θ
    ╱
   ↗
  矢印1
```

**内積という計算式を使います:**

```
cos(角度) = (矢印1 · 矢印2) / (長さ1 × 長さ2)

角度 = arccos(cos(角度)) × 180 / π
```

これで角度が「度」で求まります。

---

## 具体的な測定例: 掌屈(手のひら側に曲げる)

### 何を測っているか?

```
背屈 ↑
     |
  ---+--- ← ニュートラル(0度)
     |
掌屈 ↓
```

### どう計算しているか?

1. **4本の指の付け根の平均位置を求める**
   ```
   平均Y座標 = (人差し指.y + 中指.y + 薬指.y + 小指.y) / 4
   ```

2. **手首からの高さの差を計算**
   ```
   高さの差 = 平均Y座標 - 手首.y
   ```

3. **水平距離も計算**
   ```
   水平距離 = |平均X座標 - 手首.x|
   ```

4. **arctan2という関数で角度に変換**
   ```
   角度 = arctan2(高さの差, 水平距離) × 180 / π
   ```

### なぜこの方法?

小指側からカメラで撮影すると、掌屈のときに指が**下に移動**します。
この「下への移動量」を測れば、曲がった角度がわかります。

```
ニュートラル:  手首 ●----● 指

掌屈30度:     手首 ●
                   ＼
                    ＼
                     ● 指 (下に移動)
```

---

## なぜ正確に測れるのか?

### 理由1: 3D座標を使っている
平面の写真だけでなく、**奥行き(Z座標)**も含めた3D座標でベクトル計算するので、より正確です。

### 理由2: 複数のポイントを使っている
1つの点だけでなく、4本の指の付け根の**平均**を使うので、ブレにくいです。

### 理由3: 信頼度を計算している
AIの検出が曖昧なときは「信頼度が低い」と判定し、その測定は使いません。

```typescript
信頼度 = ベクトルの長さ / 基準値

信頼度が0.3未満 → 測定無効
信頼度が0.8以上 → 高精度
```

### 理由4: 移動平均で滑らかにしている
一瞬のブレを減らすため、過去5回分の測定の平均を表示します。

```
測定1: 25度
測定2: 27度
測定3: 26度  → 平均: 26度
測定4: 25度
測定5: 27度
```

---

## 各方向の測定方法まとめ

### 掌屈・背屈 (前後の曲げ)
- **使う点**: 手首、4本の指の付け根、中指の先
- **計算**: Y座標の差 ÷ X座標の差 = 角度
- **範囲**: 掌屈 0-90度、背屈 0-70度

### 尺屈・橈屈 (左右の傾き)
- **使う点**: 手首、人差し指付け根、小指付け根
- **計算**: 手首へのベクトルと垂直線の角度
- **範囲**: 各0-45度

### 親指の動き
- **使う点**: 親指の関節3つ(CMC, MCP, TIP)
- **計算**: 関節間の角度
- **範囲**: 動作により0-90度

---

## 技術用語の解説

### MediaPipe
Googleが開発した、カメラ映像から人の体を認識するAI技術。
スマホでもPCでも動く軽量設計。

### ランドマーク
体の特徴的なポイント(関節など)のこと。
手は21個、体全体は33個のランドマークがあります。

### ベクトル
向きと長さを持つ矢印。
数学で角度を計算するときに使います。

### 内積 (Dot Product)
2つのベクトルから角度を求める計算式。
```
内積 = v1.x × v2.x + v1.y × v2.y + v1.z × v2.z
```

### 外積 (Cross Product)
2つのベクトルに垂直な新しいベクトルを作る計算。
手のひらの「向き」を知るために使います。

### arccos / arctan2
角度を求める関数。
- arccos: コサインの値から角度を逆算
- arctan2: Y座標とX座標から角度を計算

---

## 実際の測定画面の見方

### リアルタイム表示
```
┌─────────────────────┐
│  カメラ映像         │
│                     │
│   ●--●--●          │  ← AIが検出した点
│    ＼              │
│     ●              │
│                     │
└─────────────────────┘

掌屈: 35° ███████░░░ 信頼度: 0.85
背屈: 0°  ░░░░░░░░░ 信頼度: 0.30 (低)
```

- **緑色**: 信頼度が高い測定
- **黄色**: 信頼度が中程度
- **赤色**: 信頼度が低い(参考程度)

### 履歴グラフ
```
角度
 ↑
90│         ●
  │       ／
60│     ●
  │   ／
30│ ●
  │
 0└──────────→ 日付
   1日 2日 3日
```

過去のデータと比較して、改善度がわかります。

---

## よくある質問

### Q: センサーが必要?
**A:** 不要です。普通のカメラだけでOKです。

### Q: なぜ分度器より正確なの?
**A:** 人が目で見て測ると誤差が出ますが、AIは毎回同じ基準で測定するので一貫性があります。

### Q: 暗い部屋でも使える?
**A:** ある程度の明るさが必要です。顔認識と同じくらいの照明があれば大丈夫です。

### Q: 左右の手で違いがある?
**A:** MediaPipeは左右を自動判定します。設定で測定する手を指定できます。

### Q: 病院の機器と同じ精度?
**A:** 医療機器ほどではありませんが、日常のリハビリ記録には十分です。正式な診断には医療機関を受診してください。

---

## まとめ

このアプリの角度測定は:
1. **AI**が手を21個の点として認識
2. **ベクトル計算**で点と点の関係を数値化
3. **三角関数**で角度に変換

というシンプルな3ステップです。

特別な機器は不要で、**Webカメラだけ**で医療現場並みの測定ができます。

---

**展示での説明に困ったら、このドキュメントを見せてください。**
**スマホでも読みやすいように、シンプルに作っています。**
